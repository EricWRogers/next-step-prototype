<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NextStep</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
  <script type="module" src="https://unpkg.com/pocketbase/dist/pocketbase.es.js"></script>

  <script src="nav-bar/bar-script.js"></script>
  <script language="javascript">
    let currentRoomId = null;
  </script>
</head>

<body>
  <div class="top-bar">
    <div class="user-info">
      <div class="avatar"><i data-lucide="user"></i></div>
      <span class="greeting" id="user-greeting">Hello, Mellow!</span>
    </div>
    <div class="top-icon" id="search-icon"><i data-lucide="search"></i></div>
    <div class="top-icon"><i data-lucide="bell"></i></div>
  </div>

  <div class="color-grid" id="dashboard-content">
    <div class="top-block"></div>
    <div class="color-box" style="background-color: #fde2cf"></div>
    <div class="color-box" style="background-color: #e4deff"></div>
    <div class="color-box" style="background-color: #cdf1ef"></div>
    <div class="color-box" style="background-color: #fa5c5c"></div>
  </div>

  <div class="todo-screen" id="todo-content">
    <div class="section-header">
      <strong>Challenges</strong>
      <i data-lucide="chevron-down" class="dropdown-icon"></i>
    </div>

    <div class="challenge-row">
      <div class="challenge-box"><i data-lucide="plus"></i></div>
      <div class="challenge-box selected"></div>
      <div class="challenge-box selected"></div>
      <div class="challenge-box"></div>
      <div class="challenge-box"></div>
    </div>

    <div class="todo-section">
      <div class="todo-group">
        <strong>Daily</strong>
        <div class="todo-item">
          <span>Pray for my wife</span><input type="checkbox" />
        </div>
        <div class="todo-item">
          <span>Scripture Memory</span><input type="checkbox" />
        </div>
      </div>

      <div class="todo-group">
        <strong>Weekly</strong>
        <div class="todo-item">
          <span>Serve my Church</span><input type="checkbox" />
        </div>
      </div>

      <div class="todo-group">
        <strong>Bucket-List</strong>
        <div class="todo-item">
          <span>Get a Tattoo</span><input type="checkbox" />
        </div>
      </div>
    </div>
  </div>

  <div id="chat-room-content">
    <div class="room-list" id="room-list"></div>
  </div>

  <div id="events-content" style="display:none; max-width:600px; margin:2rem auto; padding:0 1rem;">
    <h2 style="text-align:center; margin-bottom:1rem;">Upcoming Events</h2>
    <div class="event-list" id="event-list"></div>
  </div>

  <div id="chat-content" id="chat-content">
    <button class="back-btn" id="back-to-rooms">‚Üê Back to rooms</button>
    <div class="chat-container">
      <div id="chat-header" style="font-weight:600;margin-bottom:1rem;"></div>
      <div id="message-list" class="message-list"></div>
      <form id="message-form" class="message-form">
        <input type="text" id="msg-input" placeholder="Type a message‚Ä¶" />
        <input type="file" id="msg-attachments" multiple />
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <div id="nav-bar-container"></div>
  <!--nav bar-->
  <script language="javascript">
    document.getElementById("search-icon")
      .addEventListener("click", () => {
        window.location.href = "group-join.html";
      });

    fetch("nav-bar/bar.html")
      .then((response) => response.text())
      .then((html) => {
        document.getElementById("nav-bar-container").innerHTML = html;
        lucide.createIcons();
        bar_init();

        const dashboard = document.getElementById("dashboard-content");
        const chatRooms = document.getElementById("chat-room-content");
        const chat = document.getElementById("chat-content");
        const events = document.getElementById("events-content");
        const todo = document.getElementById("todo-content");

        // Listen for nav-change event
        window.addEventListener("nav-change", (e) => {
          const index = e.detail.index;

          // to handle clicking the chat in nav again
          if (index === 1 && chat.style.display === "block")
            currentRoomId = null;
          
          dashboard.style.display = index === 0 ? "grid" : "none";          
          chat.style.display = (index === 1 && currentRoomId != null) ? "block" : "none";
          chatRooms.style.display = (index === 1 && currentRoomId == null) ? "block" : "none";
          events.style.display = (index === 2) ? "block" : "none";
          todo.style.display = index === 4 ? "grid" : "none";

          if (index === 2) loadEvents();
        });

        // Initial state
        dashboard.style.display = "grid";
        chat.style.display = "none";
        chatRooms.style.display = "none";
        events.style.display = "none";
        todo.style.display = "none";
      });
  </script>
  <!--top bar-->
  <script language="javascript">
    (function () {
      const pb = new PocketBase("http://127.0.0.1:8090");

      // 1) if not logged in, go to login
      if (!pb.authStore.isValid) {
        window.location.href = "login.html";
        return;
      }

      // 2) grab the user model
      const user = pb.authStore.model;

      // 3) set greeting
      const name = user.name || user.email;
      document.getElementById("user-greeting").textContent = `Hello, ${name}`;

      // 4) render avatar if available
      const avatarContainer = document.querySelector(".avatar");
      if (user.avatar) {
        const url = pb.getFileUrl(user, user.avatar);
        const img = document.createElement("img");
        img.src = url;
        img.alt = name;
        avatarContainer.innerHTML = "";
        avatarContainer.appendChild(img);
      }
    })();
  </script>
  <!--rooms and chat-->
  <script language="javascript">
    (function () {
      const pb = new PocketBase("http://127.0.0.1:8090");

      async function ensureAuth() {
        if (!pb.authStore.isValid) {
          window.location.href = "login.html";
          throw "not-auth";
        }
      }

      async function loadRooms() {
        await ensureAuth();
        const userId = pb.authStore.model.id;
        const reqs = await pb.collection("groups")
          .getFullList({ filter: `members ~ "${userId}"` });
        const groupIds = reqs.map(r => r.id);
        if (!groupIds.length) {
          document.getElementById("room-list").textContent = "No rooms yet.";
          return;
        }
        const filter = groupIds.map(g => `group="${g}"`).join("||");
        const rooms = await pb.collection("chat_rooms")
          .getFullList({ filter });
        rooms.forEach(r => renderRoom(r));
      }

      async function renderRoom(room) {
        const list = document.getElementById("room-list");
        const item = document.createElement("div");
        item.className = "room-item";

        // 1) build thumbnail URL
        const thumbUrl = room.picture
          ? pb.getFileUrl(room, room.picture)
          : "/assets/default-room.png";

        // 2) fetch the last message (if any)
        let previewText = "";
        let previewTime = "";
        try {
          const res = await pb
            .collection("chat_messages")
            .getList(1, 1, {
              filter: `room="${room.id}"`,
              sort: "-created",
              expand: "sender",
              '$autoCancel': false    // ‚Üê opt out here
            });
          if (res.items.length) {
            const msg = res.items[0];
            // either use text or indicate attachment
            previewText = msg.text
              ? msg.text.length > 50
                ? msg.text.slice(0, 47) + "‚Ä¶"    // truncate
                : msg.text
              : "[üìé attachment]";
            // format time, e.g. ‚Äú3:45 PM‚Äù
            const d = new Date(msg.created);
            previewTime = d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
          }
        } catch (e) {
          console.warn("Could not load last message for room", room.id, e);
        }

        // 3) render the card
        item.innerHTML = `
    <div class="room-info">
      <img src="${thumbUrl}" alt="${room.name}" />
      <div class="title">${room.name}</div>
    </div>
    <div class="room-meta">
      <div class="preview">${previewText}</div>
      <div class="time">${previewTime}</div>
    </div>
  `;

        // 4) clicking either opens the chat
        const open = () => openChat(room.id, room.title);
        item.addEventListener("click", open);

        list.appendChild(item);
      }

      function openChat(roomId, title) {
        currentRoomId = roomId;
        document.getElementById("chat-room-content").style.display = "none";
        document.getElementById("chat-content").style.display = "block";
        document.getElementById("chat-header").textContent = title;
        initChat();
      }

      document.getElementById("back-to-rooms")
        .addEventListener("click", () => {
          document.getElementById("chat-content").style.display = "none";
          document.getElementById("chat-room-content").style.display = "block";
          document.getElementById("room-list").innerHTML = "";
          currentRoomId = null;
          loadRooms();
        });

      window.addEventListener("nav-change", (e) => {
        const index = e.detail.index;
        if (index === 1 && currentRoomId == null) {
          document.getElementById("chat-content").style.display = "none";
          document.getElementById("chat-room-content").style.display = "block";
          document.getElementById("room-list").innerHTML = "";
          loadRooms();
        }
      });
      // ---- chat logic ----

      async function initChat() {
        await ensureAuth();
        document.getElementById("message-list").innerHTML = "";
        // subscribe for new messages
        console.log(currentRoomId);
        pb.collection("chat_messages")
          .subscribe('*', async (e) => {
            console.log("new message! before if");
            if (e.action === "create") {
              // e.record is the raw record without expanded sender,
              // so re-fetch it expanded if you need the sender name:
              console.log("new message!");
              const msg = await pb
                .collection("chat_messages")
                .getOne(e.record.id, { expand: "sender" });
              renderMessage(msg);
            }
          }, {
            filter: `room = '${currentRoomId}'`
          });

        // existing messages once
        const msgs = await pb
          .collection("chat_messages")
          .getFullList({
            filter: `room="${currentRoomId}"`,
            sort: "-created",
            expand: "sender"
          });
        msgs.reverse().forEach(renderMessage);

        document.getElementById("message-form")
          .onsubmit = async ev => {
            ev.preventDefault();
            const text = document.getElementById("msg-input").value.trim();
            const files = document.getElementById("msg-attachments").files;
            if (!text && files.length === 0) return;
            const fd = new FormData();
            fd.append("room", currentRoomId);
            fd.append("sender", pb.authStore.model.id);
            if (text) fd.append("text", text);
            for (let f of files) fd.append("attachments", f);
            await pb.collection("chat_messages").create(fd);
            ev.target.reset();
          };
      }

      function renderMessage(msg) {
        const ul = document.getElementById("message-list");
        const me = pb.authStore.model.id;
        const isMe = msg.sender === me;
        const li = document.createElement("div");
        li.className = "message-item " + (isMe ? "mine" : "other");

        const senderName =
          msg.expand?.sender?.username || msg.expand?.sender?.name || msg.sender;

        li.innerHTML = `
    <div class="sender">${senderName}</div>
    <div class="text">${msg.text || ""}</div>
    <div class="attachments"></div>
    <div class="time">${new Date(msg.created).toLocaleTimeString()}</div>
  `;

        // render attachments (images or file links)
        const attDiv = li.querySelector(".attachments");
        if (msg.attachments && msg.attachments.length) {
          msg.attachments.forEach((filename) => {
            const url = pb.getFileUrl(msg, filename);
            const ext = filename.split(".").pop().toLowerCase();
            if (["png", "jpg", "jpeg", "gif", "webp"].includes(ext)) {
              const img = document.createElement("img");
              img.src = url;
              img.alt = filename;
              attDiv.appendChild(img);
            } else {
              const a = document.createElement("a");
              a.href = url;
              a.textContent = filename;
              a.target = "_blank";
              attDiv.appendChild(a);
            }
          });
        }

        ul.appendChild(li);
        ul.scrollTop = ul.scrollHeight;
      }

    })();
  </script>
  <!--events-->
  <script>
    (function () {
      const pb = new PocketBase("http://127.0.0.1:8090");

      async function loadEvents() {
        if (!pb.authStore.isValid) return window.location.href = "login.html";
        const userId = pb.authStore.model.id;

        const evs = await pb.collection("events")
          .getFullList({ sort: "time", expand: "group" });

        const list = document.getElementById("event-list");
        list.innerHTML = "";
        evs.forEach(renderEvent);
      }

      function renderEvent(ev) {
        const list = document.getElementById("event-list");
        const item = document.createElement("div");
        item.className = "event-item";

        // thumbnail or fallback

        const thumb = ev.override_image
          ? pb.getFileUrl(ev, ev.override_image)
          : pb.getFileUrl(ev.expand.group, ev.expand.group.profile);

        // formatted time
        const ts = new Date(ev.time).toLocaleString([], {
          dateStyle: 'medium', timeStyle: 'short'
        });

        item.innerHTML = `
    <div class="event-info">
      <img src="${thumb}" alt="${ev.title}" />
      <div class="event-text">
        <div class="event-header">
          <div class="event-title">${ev.title}</div>
          <div class="event-time">${ts}</div>
        </div>
        <div class="event-desc">${ev.description || ""}</div>
      </div>
    </div>
  `;

        // optional click to show details later
        list.appendChild(item);
      }

      // expose to nav-change
      window.loadEvents = loadEvents;
    })();
  </script>

</body>

</html>