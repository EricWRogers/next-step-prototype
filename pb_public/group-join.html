<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Join a Group</title>
    <meta name="theme-color" content="#f6f2ee" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="NextStep" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="assets/pwa/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="assets/pwa/icon-32.png" />
    <link rel="stylesheet" href="login-style.css" />
    <script src="script.js" defer></script>
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
</head>

<body>
    <div class="login-page">
        <h2>Select a Group to Join</h2>
        <div id="group-list" class="group-list">
            <!-- groups will be injected here -->
        </div>
    </div>

    <script>
        const pb = new PocketBase(window.location.origin);
        let requestSentCount = 0;

        // creates (once) and shows/hides the NextStep button
        function updateNextStepButton() {
            let next = document.getElementById("next-step-btn");
            if (!next) {
                next = document.createElement("button");
                next.id = "next-step-btn";
                next.className = "btn btn-primary";
                next.textContent = "NextStep";
                next.style.display = "none";
                // wire up your final step:
                next.addEventListener("click", () => {
                    window.location.href = "index.html";
                });
                document.getElementById("group-list").after(next);
            }
            next.style.display = requestSentCount > 0 ? "block" : "none";
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const toRad = v => (v * Math.PI) / 180;
            const R = 6371;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) *
                Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function renderGroups() {
            if (!pb.authStore.isValid) {
                window.location.href = "login.html";
                return;
            }

            // fetch all existing requests by this user
            const me = pb.authStore.model.id;
            const requests = await pb.collection("group_requests")
                .getFullList({ filter: `user="${me}"` });
            const requestMap = new Map(requests.map(r => [r.group, r.id]));

            // update next set button
            requestSentCount = requests.length;
            updateNextStepButton();

            // get geo-location
            async function renderGroupsForLocation(userLat, userLon) {
                // fetch & sort groups
                const groups = await pb.collection("groups").getFullList();
                groups
                    .map(g => {
                        const lon = parseFloat(g.location.lon);
                        const lat = parseFloat(g.location.lat);
                        return {
                            ...g,
                            dist: getDistance(userLat, userLon, lat, lon),
                            // mark requested & store request-id if exists
                            requested: requestMap.has(g.id),
                            requestId: requestMap.get(g.id) || null
                        };
                    })
                    .sort((a, b) => a.dist - b.dist)
                    .forEach(addGroupRow);
            }

            const fallbackToMagnolia = async () => {
                // Magnolia, AR fallback when geolocation is unavailable.
                await renderGroupsForLocation(33.2676, -93.2393);
            };

            if (!navigator.geolocation || !window.isSecureContext) {
                await fallbackToMagnolia();
            } else {
                navigator.geolocation.getCurrentPosition(
                    async pos => {
                        await renderGroupsForLocation(pos.coords.latitude, pos.coords.longitude);
                    },
                    fallbackToMagnolia
                );
            }
        }

        function addGroupRow(g) {
            const container = document.getElementById("group-list");
            const row = document.createElement("div");
            row.classList.add("group-item");


            // build profile URL
            const imgUrl = g.profile
                ? pb.files.getURL(g, g.profile)
                : "/assets/default-avatar.png";

            // render card
            row.innerHTML = `
      <div class="group-info">
        <img src="${imgUrl}" alt="${g.name}" />
        <div class="group-text">
          <span class="name">${g.name}</span>
          <span class="location">${g.city}, ${g.state}</span>
        </div>
      </div>
      <div class="group-meta">
        <button class="btn btn-request">
          ${g.requested ? "Requested ✔" : "Request Join"}
        </button>
      </div>
    `;

            // handle toggle
            const btn = row.querySelector(".btn-request");
            btn.addEventListener("click", async () => {
                btn.disabled = true;
                try {
                    if (!g.requested) {
                        // create new request
                        const rec = await pb.collection("group_requests")
                            .create({ group: g.id, user: pb.authStore.model.id });
                        g.requested = true;
                        g.requestId = rec.id;
                        btn.textContent = "Requested ✔";
                    } else {
                        // delete existing
                        await pb.collection("group_requests").delete(g.requestId);
                        g.requested = false;
                        g.requestId = null;
                        btn.textContent = "Request Join";
                    }

                    const requests = await pb.collection("group_requests")
                        .getFullList({ filter: `user="${pb.authStore.model.id}"` });
                    requestSentCount = requests.length;
                    updateNextStepButton();
                } catch (e) {
                    alert("Error: " + e.message);
                } finally {
                    btn.disabled = false;
                }
            });

            container.appendChild(row);
        }

        document.addEventListener("DOMContentLoaded", renderGroups);
    </script>
</body>

</html>
