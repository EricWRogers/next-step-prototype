<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NextStep Chat</title>
    <link rel="stylesheet" href="login-style.css" />
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    <style>
        /* layout */
        #rooms-list,
        #chat-content {
            max-width: 600px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        #chat-content {
            display: none;
        }

        .room-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
        }

        .room-item:hover {
            background: #f9f9f9;
        }

        .room-item .title {
            font-weight: 500;
        }

        .enter-btn {
            padding: 0.4rem 0.75rem;
            border: none;
            border-radius: 4px;
            background: #e4bf4b;
            color: #fff;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .room-info img {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 80vh;
        }

        #message-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #fafafa;
        }

        .message-item {
            margin-bottom: 1rem;
        }

        .message-item .sender {
            font-weight: 600;
        }

        .message-item .attachments img {
            max-width: 150px;
            display: block;
            margin-top: .5rem;
        }

        .message-form {
            display: flex;
            gap: .5rem;
            align-items: center;
        }

        .message-form input[type="text"] {
            flex: 1;
            padding: .5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .message-form input[type="file"] {
            flex-shrink: 0;
        }

        .message-form button {
            padding: .5rem 1rem;
            border: none;
            border-radius: 4px;
            background: #e4bf4b;
            color: #fff;
            cursor: pointer;
        }

        .back-btn {
            margin-bottom: 1rem;
            background: transparent;
            border: none;
            color: #007bff;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2 style="text-align:center;">Your Chat Rooms</h2>
    <div id="rooms-list">
        <div class="room-list" id="room-list"></div>
    </div>

    <div id="chat-content">
        <button class="back-btn" id="back-to-rooms">‚Üê Back to rooms</button>
        <div class="chat-container">
            <div id="chat-header" style="font-weight:600;margin-bottom:1rem;"></div>
            <div id="message-list" class="message-list"></div>
            <form id="message-form" class="message-form">
                <input type="text" id="msg-input" placeholder="Type a message‚Ä¶" />
                <input type="file" id="msg-attachments" multiple />
                <button type="submit">Send</button>
            </form>
        </div>
    </div>

    <script>
        (function () {
            const pb = new PocketBase("http://127.0.0.1:8090");
            let currentRoomId = null;

            async function ensureAuth() {
                if (!pb.authStore.isValid) {
                    window.location.href = "login.html";
                    throw "not-auth";
                }
            }

            async function loadRooms() {
                await ensureAuth();
                const userId = pb.authStore.model.id;
                const reqs = await pb.collection("groups")
                    .getFullList({ filter: `members ~ "${userId}"` });
                const groupIds = reqs.map(r => r.id);
                if (!groupIds.length) {
                    document.getElementById("room-list").textContent = "No rooms yet.";
                    return;
                }
                const filter = groupIds.map(g => `group="${g}"`).join("||");
                const rooms = await pb.collection("chat_rooms")
                    .getFullList({ filter });
                rooms.forEach(r => renderRoom(r));
            }

            async function renderRoom(room) {
                const list = document.getElementById("room-list");
                const item = document.createElement("div");
                item.className = "room-item";

                // 1) build thumbnail URL
                const thumbUrl = room.picture
                    ? pb.getFileUrl(room, room.picture)
                    : "/assets/default-room.png";

                // 2) fetch the last message (if any)
                let previewText = "";
                let previewTime = "";
                try {
                    const res = await pb
                        .collection("chat_messages")
                        .getList(1, 1, {
                            filter: `room="${room.id}"`,
                            sort: "-created",
                            expand: "sender",
                            '$autoCancel': false    // ‚Üê opt out here
                        });
                    if (res.items.length) {
                        const msg = res.items[0];
                        // either use text or indicate attachment
                        previewText = msg.text
                            ? msg.text.length > 50
                                ? msg.text.slice(0, 47) + "‚Ä¶"    // truncate
                                : msg.text
                            : "[üìé attachment]";
                        // format time, e.g. ‚Äú3:45 PM‚Äù
                        const d = new Date(msg.created);
                        previewTime = d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                    }
                } catch (e) {
                    console.warn("Could not load last message for room", room.id, e);
                }

                // 3) render the card
                item.innerHTML = `
    <div class="room-info">
      <img src="${thumbUrl}" alt="${room.name}" />
      <div class="title">${room.name}</div>
    </div>
    <div class="room-meta">
      <div class="preview">${previewText}</div>
      <div class="time">${previewTime}</div>
    </div>
  `;

                // 4) clicking either opens the chat
                const open = () => openChat(room.id, room.title);
                item.addEventListener("click", open);

                list.appendChild(item);
            }

            function openChat(roomId, title) {
                currentRoomId = roomId;
                document.getElementById("rooms-list").style.display = "none";
                document.getElementById("chat-content").style.display = "block";
                document.getElementById("chat-header").textContent = title;
                initChat();
            }

            document.getElementById("back-to-rooms")
                .addEventListener("click", () => {
                    document.getElementById("chat-content").style.display = "none";
                    document.getElementById("rooms-list").style.display = "block";
                    document.getElementById("room-list").innerHTML = "";
                    loadRooms();
                });

            // ---- chat logic ----

            async function initChat() {
                await ensureAuth();
                document.getElementById("message-list").innerHTML = "";
                // subscribe for new messages
                console.log(currentRoomId);
                pb.collection("chat_messages")
                    .subscribe('*', async (e) => {
                        console.log("new message! before if");
                        if (e.action === "create") {
                            // e.record is the raw record without expanded sender,
                            // so re-fetch it expanded if you need the sender name:
                            console.log("new message!");
                            const msg = await pb
                                .collection("chat_messages")
                                .getOne(e.record.id, { expand: "sender" });
                            renderMessage(msg);
                        }
                    }, {
                        filter: `room = '${currentRoomId}'`
                    });

                // existing messages once
                const msgs = await pb
                    .collection("chat_messages")
                    .getFullList({
                        filter: `room="${currentRoomId}"`,
                        sort: "-created",
                        expand: "sender"
                    });
                msgs.reverse().forEach(renderMessage);

                document.getElementById("message-form")
                    .onsubmit = async ev => {
                        ev.preventDefault();
                        const text = document.getElementById("msg-input").value.trim();
                        const files = document.getElementById("msg-attachments").files;
                        if (!text && files.length === 0) return;
                        const fd = new FormData();
                        fd.append("room", currentRoomId);
                        fd.append("sender", pb.authStore.model.id);
                        if (text) fd.append("text", text);
                        for (let f of files) fd.append("attachments", f);
                        await pb.collection("chat_messages").create(fd);
                        ev.target.reset();
                    };
            }

            function renderMessage(msg) {
                const ul = document.getElementById("message-list");
                const li = document.createElement("div");
                li.className = "message-item";

                // pull the real name (or fallback to the raw ID)
                const senderName =
                    msg.expand?.sender?.username || msg.expand?.sender?.name || msg.sender;

                li.innerHTML = `
    <div class="sender">${senderName}</div>
    <div class="text">${msg.text || ""}</div>
    <div class="attachments"></div>
    <div class="time">${new Date(msg.created).toLocaleTimeString()}</div>
  `;

                // ‚Ä¶rest of your attachment‚Äêrendering + append logic‚Ä¶
                ul.appendChild(li);
                ul.scrollTop = ul.scrollHeight;
            }


            // bootstrap
            document.addEventListener("DOMContentLoaded", loadRooms);
        })();
    </script>
</body>

</html>